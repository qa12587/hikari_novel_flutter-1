name: Auto Build APK (org.mewx.wenku8 强制生效)
on:
  push:
    branches: [ main ]  # 改代码推main，立刻自动打包
  workflow_dispatch:    # 手动触发兜底
  schedule:
    - cron: '0 0 * * *' # 每天自动打包兜底

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # ✅ 核心修复：先定位gradle文件+兼容目录，再改包名，解决找不到文件问题
      - name: Force Set Package Name to org.mewx.wenku8 (修复路径报错)
        run: |
          # 先定位build.gradle位置，兼容不同Flutter项目目录，避免找不到文件
          GRADLE_FILE=$(find . -path "*/android/app/build.gradle" | head -1)
          if [ -z "$GRADLE_FILE" ]; then
            echo "❌ 未找到android/app/build.gradle文件"
            exit 1
          fi
          # 强制替换包名为org.mewx.wenku8
          sed -i 's/applicationId "[^"]*"/applicationId "org.mewx.wenku8"/g' "$GRADLE_FILE"
          # 打印验证，确认包名修改成功
          echo "✅ 包名已强制修改为 org.mewx.wenku8，文件路径：$GRADLE_FILE"
          grep -n "applicationId" "$GRADLE_FILE"

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90
