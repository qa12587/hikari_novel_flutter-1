name: Auto Build APK (org.mewx.wenku8 强制生效)
on:
  push:
    branches: [ main ]  # 改代码推main分支，立刻自动打包
  workflow_dispatch:    # 手动触发兜底
  schedule:
    - cron: '0 0 * * *' # 每天自动打包，双重保障

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # ✅ 核心修复：强制改build.gradle，包名100%是org.mewx.wenku8
      - name: Force Set Package Name to org.mewx.wenku8
        run: |
          # 精准定位applicationId行，强制替换成org.mewx.wenku8，不管原来是什么
          sed -i 's/applicationId "[^"]*"/applicationId "org.mewx.wenku8"/g' android/app/build.gradle
          # 打印验证，打包日志能直接看到包名是否改对
          echo "✅ 包名已强制修改为："
          grep -n "applicationId" android/app/build.gradle

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90
